<?php namespace $NAMESPACE$;

use App\Http\Requests;
use Dingo\Api\Routing\Helpers;
use Mitul\Controller\AppBaseController;
use Mitul\Generator\Errors;
use $MODEL_NAMESPACE$;
use Illuminate\Http\Request;
use $REPO_NAMESPACE$\$MODEL_NAME$Repository;
use Response;
use Schema;

/*
    This class used Dingo/Api and api-generator response wrappers.
    Read the manual about responses, errors and transformers in Dingo:
    https://github.com/dingo/api/wiki
    Read the manual about responses and errors in laravel-api-generator:
    https://github.com/mitulgolakiya/laravel-api-generator/tree/master
*/

class $MODEL_NAME$APIController extends AppBaseController
{
    const MSG_SAVED = '$MODEL_NAME$ saved successfully';
    const MSG_UPDATED = '$MODEL_NAME$ updated successfully';
    const MSG_DELETED = '$MODEL_NAME$ deleted successfully';

    /**
     * \Dingo\Api\Routing
     */
    use Helpers;

    /**
     * Allowed HTTP requests
     * @var string
     */
    protected static $hateoas = [
        'list' => [
            'href' => '/$MODEL_NAME_PLURAL_CAMEL$',
            'methods' => ['GET', 'HEAD', 'POST', 'SEARCH'],
        ],
        'resource' => [
            'href' => '/$MODEL_NAME_PLURAL_CAMEL$/%id',
            'methods' => ['GET', 'HEAD', 'PUT', 'PATCH', 'DELETE'],
        ],
    ];

	/** @var  $MODEL_NAME$Repository */
	private $$MODEL_NAME_CAMEL$Repository;

	function __construct($MODEL_NAME$Repository $$MODEL_NAME_CAMEL$Repo)
	{
		$this->$MODEL_NAME_CAMEL$Repository = $$MODEL_NAME_CAMEL$Repo;
	}

	/**
	 * Display a listing of the $MODEL_NAME$.
	 * GET|HEAD /$MODEL_NAME_PLURAL_CAMEL$
	 *
	 * @param Request $request
	 *
	 * @return Response
	 */
	public function index(Request $request)
	{
	    $input = $request->all();

		$result = $this->$MODEL_NAME_CAMEL$Repository->search($input);

		$$MODEL_NAME_PLURAL_CAMEL$ = $result[0];

		return $this->response()->array($this->structurizeResponse($$MODEL_NAME_PLURAL_CAMEL$->toArray()));
	}

    /**
     * !!! It is just an example! Replace this to normal search!
     * @param $input
     * @return \Illuminate\Database\Eloquent\Collection|static[]
     */
	public function search($input)
    {
        $query = $MODEL_NAME$::query();

        $columns = Schema::getColumnListing('$TABLE_NAME$');

        foreach($columns as $attribute)
        {
            if(isset($input[$attribute]) && !empty($input[$attribute]))
            {
                $query->where($attribute, $input[$attribute]);
            }
        }

        return $query->get();
    }

    /**
	 * Show the form for creating a new $MODEL_NAME$.
	 * GET|HEAD /$MODEL_NAME_PLURAL_CAMEL$/create
	 *
	 * @return Response
	 */
	public function create()
	{
        // maybe, you can return a template for JS
        Errors::throwHttpExceptionWithCode(Errors::CREATION_FORM_NOT_EXISTS, [], static::getHATEOAS());
	}

	/**
	 * Store a newly created $MODEL_NAME$ in storage.
     * POST /$MODEL_NAME_PLURAL_CAMEL$
	 *
	 * @param Request $request
	 *
	 * @return Response
	 */
	public function store(Request $request)
	{
		if(sizeof($MODEL_NAME$::$rules) > 0) {
            $this->validateRequestOrFail($request, $MODEL_NAME$::$rules);
        }
        $input = $request->all();

		$$MODEL_NAME_PLURAL_CAMEL$ = $this->$MODEL_NAME_CAMEL$Repository->create($input);
        $response = $this->structurizeResponse($$MODEL_NAME_PLURAL_CAMEL$->toArray(), self::MSG_SAVED
                                                , true, ['%id' => $$MODEL_NAME_PLURAL_CAMEL$->getAttribute('id')]);

        return $this->response()->array($response);
	}

	/**
	 * Display the specified $MODEL_NAME$.
	 * GET|HEAD /$MODEL_NAME_PLURAL_CAMEL$/{id}
	 *
	 * @param  int $id
	 *
	 * @return Response
	 */
	public function show($id)
	{
        $$MODEL_NAME_PLURAL_CAMEL$ = $this->findOrFail($id);
        $response = $this->structurizeResponse($$MODEL_NAME_PLURAL_CAMEL$->toArray(), '', true, ['%id' => $id]);

        return $this->response()->array($response);
	}

	/**
	 * Show the form for editing the specified $MODEL_NAME$.
	 * GET|HEAD /$MODEL_NAME_PLURAL_CAMEL$/{id}/edit
	 *
	 * @param  int  $id
	 * @return Response
	 */
	public function edit($id)
	{
        // maybe, you can return a template for JS
        Errors::throwHttpExceptionWithCode(Errors::EDITION_FORM_NOT_EXISTS, ['id' => $id], static::getHATEOAS(['%id' => $id]));
	}

	/**
	 * Update the specified $MODEL_NAME$ in storage.
     * PUT/PATCH /$MODEL_NAME_PLURAL_CAMEL$/{id}
	 *
	 * @param  int    $id
	 * @param Request $request
	 *
	 * @return Response
	 */
	public function update($id, Request $request)
	{
        if(sizeof($MODEL_NAME$::$rules) > 0) {
            $this->validateRequestOrFail($request, $MODEL_NAME$::$rules);
        }
		$input = $request->all();
		$result = $this->$MODEL_NAME_CAMEL$Repository->updateRich($input, $id);
		if (!$result) {
            Errors::throwHttpExceptionWithCode(Errors::NOT_FOUND, ['id' => $id], static::getHATEOAS(['%id' => $id]));
        }
        $$MODEL_NAME_PLURAL_CAMEL$ = $this->findOrFail($id);
        $response = $this->structurizeResponse($$MODEL_NAME_PLURAL_CAMEL$->toArray(), self::MSG_UPDATED, true, ['%id' => $id]);

        return $this->response()->array($response);
	}

	/**
	 * Remove the specified $MODEL_NAME$ from storage.
     * DELETE /$MODEL_NAME_PLURAL_CAMEL$/{id}
	 *
	 * @param  int $id
	 *
	 * @return Response
	 */
	public function destroy($id)
	{
        $this->findOrFail($id);
        $this->$MODEL_NAME_CAMEL$Repository->delete($id);
        $response = $this->structurizeResponse(null, self::MSG_DELETED, true, ['%id' => $id]);

        return $this->response()->array($response);
	}

    /**
     * @param $id
     * @return $MODEL_NAME$|\Illuminate\Support\Collection|null|static
     */
    protected function findOrFail($id)
    {
        $$MODEL_NAME_PLURAL_CAMEL$ = $this->$MODEL_NAME_CAMEL$Repository->find($id);

        if (empty($$MODEL_NAME_PLURAL_CAMEL$)) {
            Errors::throwHttpExceptionWithCode(Errors::NOT_FOUND, ['id' => $id], static::getHATEOAS(['%id' => $id]));
        }

        return $$MODEL_NAME_PLURAL_CAMEL$;
    }

}
